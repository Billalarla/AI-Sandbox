{% extends 'base.html' %}

{% block title %}Calendar - WindCRM{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css" rel="stylesheet">
<style>
    .calendar-filters {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .calendar-container {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        min-height: 600px;
    }
    
    #calendar {
        min-height: 500px;
        height: auto;
    }
    
    .fc {
        font-size: 0.9rem;
    }
    
    .fc-event {
        border-radius: 4px;
        border: none !important;
        cursor: pointer;
    }
    
    .fc-event:hover {
        opacity: 0.8;
    }
    
    .fc-toolbar {
        margin-bottom: 1.5rem;
    }
    
    .fc-toolbar-title {
        font-size: 1.5rem;
        font-weight: 600;
    }
    
    .filter-section {
        margin-bottom: 1rem;
    }
    
    .filter-section label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .event-type-filters {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .form-check {
        margin-bottom: 0;
    }
    
    .legend {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #dee2e6;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }
    
    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-calendar-alt text-primary me-2"></i>
                    Calendar
                </h1>
                <div class="btn-group" role="group">
                    <a href="{% url 'tasks:create' %}" class="btn btn-outline-primary">
                        <i class="fas fa-plus me-1"></i>Add Task
                    </a>
                    <a href="{% url 'tasks:call_create' %}" class="btn btn-outline-success">
                        <i class="fas fa-phone me-1"></i>Add Call
                    </a>
                    <a href="{% url 'tasks:meeting_create' %}" class="btn btn-outline-info">
                        <i class="fas fa-users me-1"></i>Add Meeting
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="row">
        <div class="col-12">
            <div class="calendar-filters">
                <div class="row">
                    <div class="col-lg-3 col-md-6">
                        <div class="filter-section">
                            <label for="account-filter">Filter by Account</label>
                            <select id="account-filter" class="form-select">
                                <option value="">All Accounts</option>
                                {% for account in accounts %}
                                    <option value="{{ account.id }}">{{ account.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="filter-section">
                            <label for="user-filter">Filter by User</label>
                            <select id="user-filter" class="form-select">
                                <option value="">All Users</option>
                                {% for user in users %}
                                    <option value="{{ user.id }}">{{ user.get_full_name|default:user.username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="filter-section">
                            <label>Event Types</label>
                            <div class="event-type-filters">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="tasks" id="filter-tasks" checked>
                                    <label class="form-check-label" for="filter-tasks">
                                        üìã Tasks
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="calls" id="filter-calls" checked>
                                    <label class="form-check-label" for="filter-calls">
                                        üìû Calls
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="meetings" id="filter-meetings" checked>
                                    <label class="form-check-label" for="filter-meetings">
                                        ü§ù Meetings
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Legend -->
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #dc3545;"></div>
                        <span>High Priority / No Show</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #fd7e14;"></div>
                        <span>Medium Priority / In Progress</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #28a745;"></div>
                        <span>Low Priority / Completed</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #0d6efd;"></div>
                        <span>Scheduled</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ffc107;"></div>
                        <span>Postponed</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #6c757d;"></div>
                        <span>Cancelled / Default</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Calendar -->
    <div class="row">
        <div class="col-12">
            <div class="calendar-container">
                <div class="mb-3">
                    <h4>Calendar View</h4>
                    <p class="text-muted" id="calendar-status">Initializing calendar...</p>
                </div>
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<!-- Event Detail Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalTitle">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventModalBody">
                <!-- Event details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" id="editEventBtn" class="btn btn-primary">Edit</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusEl = document.getElementById('calendar-status');
    statusEl.textContent = 'DOM loaded, checking elements...';
    
    const calendarEl = document.getElementById('calendar');
    const accountFilter = document.getElementById('account-filter');
    const userFilter = document.getElementById('user-filter');
    const eventTypeFilters = document.querySelectorAll('input[type="checkbox"]');
    
    if (!calendarEl) {
        statusEl.textContent = 'ERROR: Calendar element not found!';
        statusEl.className = 'text-danger';
        return;
    }
    
    if (typeof FullCalendar === 'undefined') {
        statusEl.textContent = 'ERROR: FullCalendar library not loaded!';
        statusEl.className = 'text-danger';
        return;
    }
    
    statusEl.textContent = 'Creating calendar instance...';
    statusEl.className = 'text-info';
    
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        height: 600,
        aspectRatio: 1.35,
        events: function(fetchInfo, successCallback, failureCallback) {
            loadEvents(fetchInfo, successCallback, failureCallback);
        },
        eventClick: function(info) {
            showEventDetails(info.event);
        },
        dayMaxEvents: 3,
        moreLinkClick: 'popover',
        eventDisplay: 'block',
        displayEventTime: true,
        eventTimeFormat: {
            hour: 'numeric',
            minute: '2-digit',
            meridiem: 'short'
        },
        loading: function(isLoading) {
            if (isLoading) {
                console.log('Calendar is loading...');
            } else {
                console.log('Calendar finished loading');
            }
        }
    });
    
    statusEl.textContent = 'Rendering calendar...';
    calendar.render();
    statusEl.textContent = 'Calendar rendered successfully!';
    statusEl.className = 'text-success';
    
    // Event listeners for filters
    accountFilter.addEventListener('change', function() {
        calendar.refetchEvents();
    });
    
    userFilter.addEventListener('change', function() {
        calendar.refetchEvents();
    });
    
    eventTypeFilters.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            calendar.refetchEvents();
        });
    });
    
    function loadEvents(fetchInfo, successCallback, failureCallback) {
        const accountId = accountFilter.value;
        const userId = userFilter.value;
        const selectedTypes = Array.from(eventTypeFilters)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        
        const params = new URLSearchParams({
            start: fetchInfo.startStr,
            end: fetchInfo.endStr
        });
        
        if (accountId) params.append('account_id', accountId);
        if (userId) params.append('user_id', userId);
        selectedTypes.forEach(type => params.append('types[]', type));
        
        fetch(`{% url 'calendar_app:calendar_events_api' %}?${params}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                successCallback(data);
            })
            .catch(error => {
                console.error('Error loading events:', error);
                failureCallback(error);
            });
    }
    
    function showEventDetails(event) {
        const props = event.extendedProps;
        const modal = new bootstrap.Modal(document.getElementById('eventModal'));
        
        document.getElementById('eventModalTitle').textContent = event.title;
        
        let modalBody = `
            <div class="row">
                <div class="col-sm-3"><strong>Type:</strong></div>
                <div class="col-sm-9">${props.type.charAt(0).toUpperCase() + props.type.slice(1)}</div>
            </div>
            <div class="row mt-2">
                <div class="col-sm-3"><strong>Status:</strong></div>
                <div class="col-sm-9">
                    <span class="badge bg-secondary">${props.status.replace('_', ' ').toUpperCase()}</span>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-sm-3"><strong>Assigned To:</strong></div>
                <div class="col-sm-9">${props.assigned_to}</div>
            </div>
            <div class="row mt-2">
                <div class="col-sm-3"><strong>Start:</strong></div>
                <div class="col-sm-9">${event.start ? event.start.toLocaleString() : 'Not set'}</div>
            </div>
        `;
        
        if (event.end && !event.allDay) {
            modalBody += `
                <div class="row mt-2">
                    <div class="col-sm-3"><strong>End:</strong></div>
                    <div class="col-sm-9">${event.end.toLocaleString()}</div>
                </div>
            `;
        }
        
        if (props.type === 'task') {
            modalBody += `
                <div class="row mt-2">
                    <div class="col-sm-3"><strong>Priority:</strong></div>
                    <div class="col-sm-9">
                        <span class="badge bg-${props.priority === 'high' ? 'danger' : props.priority === 'medium' ? 'warning' : 'success'}">
                            ${props.priority.toUpperCase()}
                        </span>
                    </div>
                </div>
            `;
        }
        
        if (props.type === 'call') {
            modalBody += `
                <div class="row mt-2">
                    <div class="col-sm-3"><strong>Phone:</strong></div>
                    <div class="col-sm-9">${props.phone_number || 'Not provided'}</div>
                </div>
                <div class="row mt-2">
                    <div class="col-sm-3"><strong>Call Type:</strong></div>
                    <div class="col-sm-9">${props.call_type}</div>
                </div>
            `;
        }
        
        if (props.type === 'meeting') {
            modalBody += `
                <div class="row mt-2">
                    <div class="col-sm-3"><strong>Location:</strong></div>
                    <div class="col-sm-9">${props.location || 'Not specified'}</div>
                </div>
                <div class="row mt-2">
                    <div class="col-sm-3"><strong>Meeting Type:</strong></div>
                    <div class="col-sm-9">${props.meeting_type}</div>
                </div>
            `;
            if (props.meeting_url) {
                modalBody += `
                    <div class="row mt-2">
                        <div class="col-sm-3"><strong>Meeting URL:</strong></div>
                        <div class="col-sm-9"><a href="${props.meeting_url}" target="_blank">${props.meeting_url}</a></div>
                    </div>
                `;
            }
        }
        
        if (props.account) {
            modalBody += `
                <div class="row mt-2">
                    <div class="col-sm-3"><strong>Account:</strong></div>
                    <div class="col-sm-9">${props.account}</div>
                </div>
            `;
        }
        
        if (props.description || props.agenda) {
            modalBody += `
                <div class="row mt-3">
                    <div class="col-sm-3"><strong>Description:</strong></div>
                    <div class="col-sm-9">${props.description || props.agenda || 'No description provided'}</div>
                </div>
            `;
        }
        
        document.getElementById('eventModalBody').innerHTML = modalBody;
        document.getElementById('editEventBtn').href = props.url;
        
        modal.show();
    }
});
</script>
{% endblock %}
